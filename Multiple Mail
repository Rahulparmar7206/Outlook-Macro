Sub DownloadAttachmentsWithSenderSubfolders()
    Dim objOutlook As Object
    Dim objSelection As Object
    Dim objMail As Object
    Dim objAttachment As Object
    Dim strFolderName As String
    Dim strDesktopPath As String
    Dim strMainPath As String
    Dim strSenderPath As String
    Dim FSO As Object
    Dim intCount As Integer
    Dim strFileName As String
    Dim intCounter As Integer
    Dim strSenderName As String
    
    ' Get Desktop path
    strDesktopPath = CreateObject("WScript.Shell").SpecialFolders("Desktop")
    
    ' Prompt user for main folder name
    strFolderName = InputBox("Enter the main folder name to save attachments:", "Folder Name")
    
    ' Check if user cancelled or entered empty name
    If strFolderName = "" Then
        MsgBox "Operation cancelled. No folder name provided.", vbExclamation
        Exit Sub
    End If
    
    ' Create full path for main folder
    strMainPath = strDesktopPath & "" & strFolderName
    
    ' Create FileSystemObject
    Set FSO = CreateObject("Scripting.FileSystemObject")
    
    ' Create main folder if it doesn't exist
    If Not FSO.FolderExists(strMainPath) Then
        FSO.CreateFolder strMainPath
    End If
    
    ' Get Outlook application
    Set objOutlook = Application
    
    ' Get selected emails
    Set objSelection = objOutlook.ActiveExplorer.Selection
    
    ' Check if any emails are selected
    If objSelection.Count = 0 Then
        MsgBox "No emails selected. Please select one or more emails.", vbExclamation
        Exit Sub
    End If
    
    intCount = 0
    
    ' Loop through each selected email
    For Each objMail In objSelection
        ' Check if it's a mail item
        If TypeName(objMail) = "MailItem" Then
            ' Get sender name and clean it for folder name
            strSenderName = objMail.SenderName
            
            ' Remove invalid characters from sender name
            strSenderName = CleanFolderName(strSenderName)
            
            ' Create sender subfolder path
            strSenderPath = strMainPath & "" & strSenderName
            
            ' Create sender subfolder if it doesn't exist
            If Not FSO.FolderExists(strSenderPath) Then
                FSO.CreateFolder strSenderPath
            End If
            
            ' Check if email has attachments
            If objMail.Attachments.Count > 0 Then
                ' Loop through each attachment
                For Each objAttachment In objMail.Attachments
                    strFileName = objAttachment.FileName
                    
                    ' Check if file already exists and rename if necessary
                    intCounter = 1
                    Do While FSO.FileExists(strSenderPath & "" & strFileName)
                        Dim strExtension As String
                        Dim strBaseName As String
                        Dim intDotPos As Integer
                        
                        intDotPos = InStrRev(objAttachment.FileName, ".")
                        If intDotPos > 0 Then
                            strBaseName = Left(objAttachment.FileName, intDotPos - 1)
                            strExtension = Mid(objAttachment.FileName, intDotPos)
                        Else
                            strBaseName = objAttachment.FileName
                            strExtension = ""
                        End If
                        
                        strFileName = strBaseName & "_" & intCounter & strExtension
                        intCounter = intCounter + 1
                    Loop
                    
                    ' Save attachment in sender's subfolder
                    objAttachment.SaveAsFile strSenderPath & "" & strFileName
                    intCount = intCount + 1
                Next objAttachment
            End If
        End If
    Next objMail
    
    ' Show completion message
    MsgBox "Download complete!" & vbCrLf & vbCrLf & _
           "Total attachments saved: " & intCount & vbCrLf & _
           "Location: " & strMainPath, vbInformation, "Success"
    
    ' Clean up
    Set objAttachment = Nothing
    Set objMail = Nothing
    Set objSelection = Nothing
    Set objOutlook = Nothing
    Set FSO = Nothing
    
End Sub

' Function to clean folder names by removing invalid characters
Function CleanFolderName(strName As String) As String
    Dim strClean As String
    Dim i As Integer
    Dim strChar As String
    Dim arrInvalidChars As Variant
    
    ' Define invalid characters for folder names
    arrInvalidChars = Array("", "/", ":", "*", "?", """", "<", ">", "|")
    
    strClean = strName
    
    ' Remove invalid characters
    For i = LBound(arrInvalidChars) To UBound(arrInvalidChars)
        strClean = Replace(strClean, arrInvalidChars(i), "")
    Next i
    
    ' Trim leading and trailing spaces
    strClean = Trim(strClean)
    
    ' If name is empty after cleaning, use default
    If strClean = "" Then
        strClean = "Unknown_Sender"
    End If
    
    CleanFolderName = strClean
End Function
